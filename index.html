<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canva Style Music Quiz</title>
  <style>
    /* å…¨åŸŸè¨­å®š */
    :root {
      --canva-cyan: #00C4CC;
      --canva-pink: #FF66C4;
      --canva-purple: #7D2AE8;
      --canva-orange: #fab1a0;
      --text-dark: #2D3436;
      --text-light: #7f8c8d;
      --bg-gradient: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%);
    }

    body {
      font-family: "PingFang TC", "Quicksand", "Microsoft JhengHei", sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: var(--text-dark);
      padding: 20px;
      box-sizing: border-box;
    }

    /* å¡ç‰‡ä¸»é«” */
    .canva-card {
      background: white;
      width: 100%;
      max-width: 450px;
      padding: 40px 30px;
      border-radius: 32px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
      text-align: center;
      position: relative;
      overflow: hidden;
      transform: translateZ(0);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* è£é£¾æ€§å…ƒç´  */
    .decorator-circle {
      position: absolute;
      width: 120px;
      height: 120px;
      background: var(--canva-cyan);
      border-radius: 50%;
      opacity: 0.1;
      top: -40px;
      right: -40px;
      pointer-events: none;
    }

    .decorator-dot {
      position: absolute;
      width: 15px;
      height: 15px;
      background: var(--canva-pink);
      border-radius: 50%;
      bottom: 20px;
      left: 20px;
      opacity: 0.3;
      pointer-events: none;
    }

    h1 {
      font-size: 2rem;
      color: var(--canva-cyan);
      margin-top: 0;
      margin-bottom: 8px;
      font-weight: 800;
      letter-spacing: 1px;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 0.95rem;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    /* æ’è¡Œæ¦œæ¨£å¼ */
    .leaderboard {
      width: 100%;
      background: #f8fafc;
      border-radius: 16px;
      padding: 15px;
      margin-top: 20px;
      box-sizing: border-box;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid #edf2f7;
    }

    .leaderboard h3 {
      margin: 0 0 10px 0;
      color: var(--canva-purple);
      font-size: 1.1rem;
    }

    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
      text-align: left;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 0.9rem;
    }

    .leaderboard-item:last-child {
      border-bottom: none;
    }

    .rank-badge {
      display: inline-block;
      min-width: 25px;
      font-weight: bold;
      color: var(--canva-light);
    }
    
    .rank-1 { color: #FFD700; }
    .rank-2 { color: #C0C0C0; }
    .rank-3 { color: #CD7F32; }

    .score-badge {
      font-weight: bold;
      color: var(--canva-pink);
    }

    /* æ’­æ”¾ç‹€æ…‹è¦–è¦ºåŒ– */
    .visualizer {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      height: 40px;
      gap: 4px;
      margin-bottom: 20px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .visualizer.active {
      opacity: 1;
    }

    .bar {
      width: 4px;
      background: var(--canva-cyan);
      border-radius: 2px;
      animation: bounce 0.5s ease-in-out infinite alternate;
      will-change: height;
    }

    @keyframes bounce {
      from { height: 5px; }
      to { height: 30px; }
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-main {
      background-color: var(--canva-cyan);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 16px 32px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(0, 196, 204, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
      justify-content: center;
    }

    .btn-main:hover {
      transform: translateY(-3px) scale(1.02);
      background-color: #05d1d8;
      box-shadow: 0 8px 20px rgba(0, 196, 204, 0.4);
    }

    .btn-main:disabled {
      background-color: #b2bec3;
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }

    .btn-next {
      background-color: var(--canva-purple);
      box-shadow: 0 4px 15px rgba(125, 42, 232, 0.3);
      display: none; 
    }

    .btn-next:hover {
      background-color: #8e44ad;
      box-shadow: 0 8px 20px rgba(125, 42, 232, 0.4);
    }

    /* éŸ³æ¨‚æ§åˆ¶é … */
    audio {
      width: 100%;
      margin: 15px 0;
      filter: sepia(20%) saturate(70%) grayscale(1);
      height: 35px;
    }

    /* è¼¸å…¥å€å¡Š */
    .input-wrapper {
      position: relative;
      margin-top: 10px;
      width: 100%;
    }

    input {
      width: 100%;
      box-sizing: border-box;
      padding: 16px 20px;
      border: 2px solid #edf2f7;
      border-radius: 16px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
      background-color: #f8fafc;
      text-align: center;
    }

    input:focus {
      border-color: var(--canva-pink);
      background-color: white;
      box-shadow: 0 0 0 4px rgba(255, 102, 196, 0.1);
    }

    .btn-submit {
      background: linear-gradient(to right, var(--canva-pink), #ff8ec7);
      color: white;
      border: none;
      border-radius: 14px;
      padding: 14px;
      width: 100%;
      margin-top: 15px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s, filter 0.2s;
    }

    .btn-submit:hover {
      filter: brightness(1.05);
      transform: translateY(-2px);
    }

    .btn-submit:active {
      transform: translateY(0);
    }

    /* æ¬¡è¦æŒ‰éˆ• (çœ‹ç­”æ¡ˆ) */
    .btn-secondary {
      background-color: #f1f2f6; 
      color: var(--text-light);
      border: 2px solid #dfe6e9;
      border-radius: 14px;
      padding: 12px;
      width: 100%;
      margin-top: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background-color: #dfe6e9;
      color: var(--text-dark);
    }

    /* æç¤ºè¨Šæ¯ */
    #message {
      margin-top: 15px;
      font-size: 1rem;
      min-height: 1.5em;
      font-weight: 600;
      border-radius: 12px;
      padding: 10px;
      transition: opacity 0.3s;
      width: 100%;
    }

    .status-success {
      background-color: #e6fffa;
      color: #2d6a4f;
    }

    .status-error {
      background-color: #fff5f5;
      color: #c53030;
    }

    .status-info {
      color: var(--canva-purple);
    }

    /* é é¢åˆ‡æ›æ§åˆ¶ */
    .screen {
      display: none;
      width: 100%;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 0.5s ease;
    }
    
    .screen.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .current-score-display {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 0.9rem;
      color: var(--text-light);
      background: rgba(255, 255, 255, 0.9);
      padding: 5px 10px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* çµç®—é é¢æ¨£å¼ */
    .final-score-box {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--text-dark);
      margin: 15px 0;
      padding: 15px;
      background: #fff0f6;
      border: 2px solid var(--canva-pink);
      border-radius: 20px;
      width: 100%;
      box-sizing: border-box;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .celebrate-text {
      color: var(--canva-purple);
      font-weight: bold;
      margin-bottom: 5px;
    }

  </style>
</head>
<body>

  <div class="canva-card">
    <div class="decorator-circle"></div>
    <div class="decorator-dot"></div>

    <h1>Music Quiz</h1>
    
    <!-- 1. ç™»å…¥èˆ‡æ’è¡Œæ¦œç•«é¢ -->
    <div id="loginScreen" class="screen active">
      <p class="subtitle">è¼¸å…¥æš±ç¨±ï¼ŒæŒ‘æˆ°æ’è¡Œæ¦œå† è»ï¼</p>
      
      <div class="input-wrapper">
        <input type="text" id="username" placeholder="ä½ çš„æš±ç¨± (ä¾‹å¦‚: éŸ³æ¨‚å°å¤©æ‰)" maxlength="10">
        <button class="btn-submit" id="loginBtn">é–‹å§‹æŒ‘æˆ°</button>
      </div>

      <div class="leaderboard">
        <h3>ğŸ† æ’è¡Œæ¦œ</h3>
        <ul class="leaderboard-list">
          <li class="leaderboard-item">è¼‰å…¥ä¸­...</li>
        </ul>
      </div>
    </div>

    <!-- 2. éŠæˆ²ä¸»ç•«é¢ -->
    <div id="gameScreen" class="screen">
      <div class="current-score-display">ç›®å‰å¾—åˆ†: <span id="currentScore">0</span></div>
      <p class="subtitle" style="margin-top: 20px;">è½è½æ—‹å¾‹ï¼ŒæŒ‘æˆ°ä½ çš„éŸ³æ¨‚æ•æ„Ÿåº¦ï¼</p>

      <!-- å‹•æ…‹éŸ³é‡æ¢ -->
      <div id="visualizer" class="visualizer">
        <div class="bar" style="animation-delay: 0.0s"></div>
        <div class="bar" style="animation-delay: 0.2s"></div>
        <div class="bar" style="animation-delay: 0.4s"></div>
        <div class="bar" style="animation-delay: 0.1s"></div>
        <div class="bar" style="animation-delay: 0.3s"></div>
      </div>

      <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
        <button id="startBtn" class="btn-main" onclick="playMusic()">
          <span>ğŸµ</span> æ’­æ”¾éŸ³æ¨‚
        </button>
        
        <button id="nextBtn" class="btn-main btn-next" onclick="playMusic()">
          <span>â­ï¸</span> ä¸‹ä¸€é¦–
        </button>
        
        <!-- æ–°å¢æš«åœæŒ‰éˆ• -->
        <button id="pauseBtn" class="btn-main" style="display:none; background-color: var(--canva-orange);" onclick="togglePause()">
          <span>â¸ï¸</span> æš«åœæ’­æ”¾
        </button>
      </div>

      <!-- åŠ å…¥ onError è™•ç† -->
      <audio id="player" preload="auto" onplay="setVisualizer(true)" onpause="setVisualizer(false)" onended="setVisualizer(false)" onerror="handleAudioError()"></audio>

      <div id="quizSection" style="width: 100%;">
        <div class="input-wrapper">
          <input type="text" id="guess" placeholder="é€™é¦–æ­Œå«ä»€éº¼åå­—ï¼Ÿ" onkeypress="handleKeyPress(event)">
          <button id="submitBtn" class="btn-submit" onclick="checkAnswer()">æäº¤ç­”æ¡ˆ</button>
          <button id="showAnswerBtn" class="btn-secondary" onclick="showAnswer()">ğŸ‘€ å·çœ‹ç­”æ¡ˆ</button>
        </div>
      </div>

      <div id="message"></div>
    </div>

    <!-- 3. é€šé—œçµç®—ç•«é¢ -->
    <div id="resultScreen" class="screen">
      <h2 style="color: var(--canva-cyan); margin: 0;">ğŸ‰ æ­å–œé€šé—œï¼ ğŸ‰</h2>
      <p class="subtitle celebrate-text">å¤ªç¥å•¦ï¼ç°¡ç›´æ˜¯è¡Œèµ°çš„é»æ­Œæ©Ÿï¼ğŸ¤</p>
      
      <div class="final-score-box">
        æœ€çµ‚å¾—åˆ†ï¼š<span id="finalScore">0</span> / 5
      </div>

      <div class="leaderboard">
        <h3>ğŸ† æœ€çµ‚æ’è¡Œæ¦œ</h3>
        <ul class="leaderboard-list">
          <li class="leaderboard-item">è¼‰å…¥ä¸­...</li>
        </ul>
      </div>

      <button class="btn-main" style="background-color: var(--canva-pink); margin-top: 20px;" onclick="location.reload()">
        <span>ğŸ”„</span> é‡æ–°æŒ‘æˆ°
      </button>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- å…¨åŸŸè®Šæ•¸ ---
    let db = null;
    let auth = null;
    let currentUser = null;
    let currentScore = 0;
    let userName = "";
    let useLocalStorage = false; // æ¨™è¨˜æ˜¯å¦ä½¿ç”¨æœ¬æ©Ÿå„²å­˜
    const sessionUid = 'local_' + Date.now(); // æœ¬æ©Ÿæ¨¡å¼ä¸‹çš„æš«æ™‚ ID
    
    // è¿½è¹¤å·²ç­”å°çš„é¡Œç›®ç´¢å¼•
    let solvedIndices = []; 
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'music-quiz';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

    // --- Firebase åˆå§‹åŒ– ---
    async function initFirebase() {
      // å¦‚æœç’°å¢ƒè®Šæ•¸ä¸­æ²’æœ‰ configï¼Œç›´æ¥åˆ‡æ›åˆ°æœ¬æ©Ÿæ¨¡å¼
      if (Object.keys(firebaseConfig).length === 0) {
        console.warn("No firebase config found. Switching to Local Storage mode.");
        useLocalStorage = true;
        loadLocalLeaderboard();
        return;
      }

      try {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
            listenToLeaderboard();
          }
        });

        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Firebase init/auth failed:", e);
        // å¦‚æœ Firebase é€£ç·šå¤±æ•—ï¼Œä¹Ÿåˆ‡æ›åˆ°æœ¬æ©Ÿæ¨¡å¼ï¼Œè€Œä¸æ˜¯é¡¯ç¤ºéŒ¯èª¤
        console.warn("Firebase failed, falling back to Local Storage.");
        useLocalStorage = true;
        loadLocalLeaderboard();
      }
    }
    initFirebase();

    // --- éŠæˆ²é‚è¼¯ ---
    const songLibrary = [
      { file: "songs/å¦‚æœå‘¢ .mp3", title: "å¦‚æœå‘¢" },
      { file: "songs/ç¢ç¢å¿µ.mp3", title: "ç¢ç¢å¿µ" },
      { file: "songs/ç¯€ç´„ç”¨æ„› .mp3", title: "ç¯€ç´„ç”¨æ„›" },
      { file: "songs/æ‘¯å‹â™ª.mp3", title: "æ‘¯å‹" },
      { file: "songs/é›¢é–‹æˆ‘çš„ä¾è³´.mp3", title: "é›¢é–‹æˆ‘çš„ä¾è³´" }
    ];

    let currentSongIndex = null;
    let isGameStarted = false;
    let isLoading = false;

    window.handleLogin = async () => {
      const input = document.getElementById("username");
      const name = input.value.trim();
      if (!name) {
        alert("è«‹è¼¸å…¥æš±ç¨±ï¼");
        return;
      }
      userName = name;
      
      const loginBtn = document.getElementById("loginBtn");
      loginBtn.innerHTML = "è¼‰å…¥ä¸­...";
      loginBtn.disabled = true;
      
      document.getElementById("loginScreen").classList.remove("active");
      document.getElementById("gameScreen").classList.add("active");
      
      setTimeout(() => {
        playMusic();
      }, 100);
    };

    document.getElementById("username").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        window.handleLogin();
      }
    });
    
    document.getElementById("loginBtn").addEventListener("click", window.handleLogin);

    window.setVisualizer = (active) => {
      const viz = document.getElementById("visualizer");
      if (active) viz.classList.add("active");
      else viz.classList.remove("active");
    };
    
    // è™•ç†éŸ³è¨ŠéŒ¯èª¤
    window.handleAudioError = () => {
       console.error("Audio error occurred for file:", songLibrary[currentSongIndex].file);
       window.showMessage("âš ï¸ ç„¡æ³•è¼‰å…¥æ­¤æ­Œæ›² (å¯èƒ½æ˜¯æª”æ¡ˆä¸å­˜åœ¨æˆ–è·¯å¾‘éŒ¯èª¤)", "status-error");
       
       // è®“æŒ‰éˆ•æ¢å¾©ï¼Œå…è¨±è·³é
       const startBtn = document.getElementById("startBtn");
       const nextBtn = document.getElementById("nextBtn");
       const pauseBtn = document.getElementById("pauseBtn");
       
       startBtn.style.display = "none"; // æ—¢ç„¶å¤±æ•—ï¼Œå°±ç”¨ Next è·³é
       nextBtn.style.display = "inline-flex"; 
       nextBtn.innerHTML = '<span>â­ï¸</span> è·³éé€™é¦–';
       nextBtn.disabled = false;
       pauseBtn.style.display = "none"; // éš±è—æš«åœ
       isLoading = false;
       
       // éš±è—å·çœ‹ç­”æ¡ˆæŒ‰éˆ•
       document.getElementById("showAnswerBtn").style.display = "none";
    };

    // æ–°å¢ï¼šåˆ‡æ›æš«åœ/æ’­æ”¾
    window.togglePause = () => {
      const player = document.getElementById("player");
      const btn = document.getElementById("pauseBtn");
      
      if (player.paused) {
        player.play();
        btn.innerHTML = '<span>â¸ï¸</span> æš«åœæ’­æ”¾';
      } else {
        player.pause();
        btn.innerHTML = '<span>â–¶ï¸</span> ç¹¼çºŒæ’­æ”¾';
      }
    };

    window.playMusic = async () => {
      if (isLoading) return;
      
      // 1. ç¯©é¸å‡ºé‚„æ²’ç­”å°çš„æ­Œæ›²ç´¢å¼•
      const availableIndices = songLibrary.map((_, index) => index).filter(index => !solvedIndices.includes(index));

      // 2. å¦‚æœæ²’æœ‰å‰©é¤˜æ­Œæ›²ï¼Œè¡¨ç¤ºå…¨ç ´
      if (availableIndices.length === 0) {
        showResultScreen();
        return;
      }

      const startBtn = document.getElementById("startBtn");
      const nextBtn = document.getElementById("nextBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const player = document.getElementById("player");

      isLoading = true;
      const originalStartText = startBtn.innerHTML;
      const originalNextText = nextBtn.innerHTML;
      
      startBtn.innerHTML = '<span>â³</span> è¼‰å…¥ä¸­...';
      startBtn.disabled = true;
      nextBtn.innerHTML = '<span>â³</span> è¼‰å…¥ä¸­...';
      nextBtn.disabled = true;

      // 3. å¾å‰©é¤˜æ­Œæ›²ä¸­éš¨æ©ŸæŒ‘é¸
      let randomIndex = Math.floor(Math.random() * availableIndices.length);
      let nextIndex = availableIndices[randomIndex];

      // å˜—è©¦é¿å…é€£çºŒé‡è¤‡æ’­æ”¾åŒä¸€é¦–ï¼ˆå¦‚æœé‚„æœ‰å…¶ä»–é¸æ“‡ï¼‰
      if (availableIndices.length > 1 && nextIndex === currentSongIndex) {
         nextIndex = availableIndices[(randomIndex + 1) % availableIndices.length];
      }
      
      currentSongIndex = nextIndex;
      player.src = songLibrary[currentSongIndex].file;
      player.load();

      try {
        await player.play();
        isGameStarted = true;
        window.showMessage("ğŸ§ éŸ³æ¨‚éŸ¿èµ·ï¼ŒçŒœçŒœçœ‹å§ï¼", "status-info");
        
        startBtn.style.display = "none";
        nextBtn.style.display = "none";
        
        // é¡¯ç¤ºæš«åœæŒ‰éˆ•ä¸¦é‡ç½®ç‹€æ…‹
        pauseBtn.style.display = "inline-flex";
        pauseBtn.innerHTML = '<span>â¸ï¸</span> æš«åœæ’­æ”¾';

        document.getElementById("quizSection").style.opacity = "1";
        document.getElementById("guess").disabled = false;
        document.getElementById("submitBtn").disabled = false;
        document.getElementById("guess").value = "";
        
        // ç¢ºä¿å·çœ‹ç­”æ¡ˆæŒ‰éˆ•é¡¯ç¤º
        document.getElementById("showAnswerBtn").style.display = "block";
        document.getElementById("showAnswerBtn").disabled = false;
        
        setTimeout(() => {
           document.getElementById("guess").focus();
        }, 100);

        // Reset btns
        startBtn.disabled = false;
        startBtn.innerHTML = '<span>ğŸµ</span> æ’­æ”¾éŸ³æ¨‚';
        nextBtn.disabled = false;
        nextBtn.innerHTML = '<span>â­ï¸</span> ä¸‹ä¸€é¦–';

      } catch (e) {
        // å¦‚æœæ˜¯ç€è¦½å™¨é˜»æ“‹è‡ªå‹•æ’­æ”¾ï¼Œæˆ–æ˜¯å…¶ä»–éŒ¯èª¤ (onerror æœƒé¡å¤–è§¸ç™¼)
        console.error("Play failed:", e);
        if (e.name === 'NotAllowedError') {
             window.showMessage("è«‹æ‰‹å‹•é»æ“Šæ’­æ”¾å™¨æŒ‰éˆ• â–¶", "status-info");
             player.controls = true;
        }
        
        startBtn.disabled = false;
        startBtn.innerHTML = originalStartText;
        nextBtn.disabled = false;
        nextBtn.innerHTML = originalNextText;
      } finally {
        isLoading = false;
      }
    };

    window.showMessage = (text, className) => {
      const messageDiv = document.getElementById("message");
      messageDiv.textContent = text;
      messageDiv.className = className;
    };

    window.showResultScreen = () => {
      document.getElementById("gameScreen").classList.remove("active");
      document.getElementById("resultScreen").classList.add("active");
      document.getElementById("finalScore").innerText = currentScore;
    };

    // æ–°å¢ï¼šé¡¯ç¤ºç­”æ¡ˆåŠŸèƒ½
    window.showAnswer = () => {
      if (!isGameStarted) return;
      
      const currentSong = songLibrary[currentSongIndex];
      
      // åœæ­¢æ’­æ”¾
      const player = document.getElementById("player");
      player.pause();
      window.setVisualizer(false);
      
      // éš±è—æš«åœæŒ‰éˆ•
      document.getElementById("pauseBtn").style.display = "none";

      // é¡¯ç¤ºè¨Šæ¯
      window.showMessage(`é€™é¦–æ­Œæ˜¯ï¼š${currentSong.title}`, "status-info");
      
      // ç¦ç”¨è¼¸å…¥èˆ‡æŒ‰éˆ•
      document.getElementById("guess").disabled = true;
      document.getElementById("submitBtn").disabled = true;
      document.getElementById("showAnswerBtn").style.display = "none";
      
      // æ¨™è¨˜ç‚ºå·²è™•ç†ï¼ˆä½†ä¸åŠ åˆ†ï¼‰
      if (!solvedIndices.includes(currentSongIndex)) {
          solvedIndices.push(currentSongIndex);
      }
      
      // æª¢æŸ¥æ˜¯å¦çµæŸæˆ–é¡¯ç¤ºä¸‹ä¸€é¦–
      if (solvedIndices.length === songLibrary.length) {
          setTimeout(() => {
             window.showResultScreen();
          }, 2000);
      } else {
          document.getElementById("nextBtn").style.display = "inline-flex";
      }
    };

    window.checkAnswer = async () => {
      if (!isGameStarted) return;

      const guessInput = document.getElementById("guess").value.trim();
      
      if (!guessInput) {
        window.showMessage("è«‹è¼¸å…¥ç­”æ¡ˆå¾Œå†æäº¤", "status-error");
        return;
      }

      const correctAnswer = songLibrary[currentSongIndex].title;

      if(guessInput === correctAnswer) {
        // ç­”å°é‚è¼¯
        const player = document.getElementById("player");
        player.pause();
        player.currentTime = 0;
        window.setVisualizer(false);

        // éš±è—æš«åœæŒ‰éˆ•
        document.getElementById("pauseBtn").style.display = "none";

        // è¨˜éŒ„æ­¤é¡Œå·²ç­”å°ï¼Œé¿å…é‡è¤‡å‡ºç¾
        if (!solvedIndices.includes(currentSongIndex)) {
            solvedIndices.push(currentSongIndex);
            
            // æ›´æ–°åˆ†æ•¸
            currentScore++;
            document.getElementById("currentScore").innerText = currentScore;
            await saveScore(currentScore);
        }

        // æª¢æŸ¥æ˜¯å¦å…¨ç ´
        if (solvedIndices.length === songLibrary.length) {
            window.showMessage("ğŸ† å¤ªå¼·äº†ï¼å…¨éƒ¨é€šé—œï¼ (+1åˆ†) ğŸ†", "status-success");
            // ç¨ç­‰ä¸€ä¸‹å†è·³è½‰ï¼Œè®“ç©å®¶çœ‹åˆ°è¨Šæ¯
            setTimeout(() => {
              showResultScreen();
            }, 1500);
        } else {
            window.showMessage("âœ¨ å¤ªæ£’äº†ï¼ç­”å°äº† (+1åˆ†) âœ¨", "status-success");
            // é¡¯ç¤ºä¸‹ä¸€é¦–æŒ‰éˆ•
            document.getElementById("nextBtn").style.display = "inline-flex";
            document.getElementById("guess").disabled = true;
            document.getElementById("submitBtn").disabled = true;
            document.getElementById("showAnswerBtn").style.display = "none"; // ç­”å°ä¹Ÿéš±è—å·çœ‹
        }

      } else {
        window.showMessage("å“å‘€ï¼Œå·®ä¸€é»é»ï¼å†è½ä¸€æ¬¡çœ‹çœ‹ï¼Ÿ ğŸ’ª", "status-error");
      }
    };

    window.handleKeyPress = (event) => {
      if (event.key === "Enter") {
        const guessInput = document.getElementById("guess");
        if (!guessInput.disabled) window.checkAnswer();
      }
    };

    // --- è³‡æ–™å„²å­˜é‚è¼¯ (æ”¯æ´ Firebase èˆ‡ æœ¬æ©Ÿå„²å­˜) ---
    
    async function saveScore(score) {
      // å¦‚æœä½¿ç”¨æœ¬æ©Ÿæ¨¡å¼
      if (useLocalStorage) {
         saveLocalScore(score);
         return;
      }

      if (!currentUser || !db) return;
      try {
        const userScoreRef = doc(db, 'artifacts', appId, 'public', 'data', 'scores', currentUser.uid);
        await setDoc(userScoreRef, {
          name: userName,
          score: score,
          timestamp: Date.now()
        }, { merge: true });
      } catch (e) {
        console.error("Error saving score to Firebase:", e);
        // å¦‚æœ Firebase å¯«å…¥å¤±æ•—ï¼Œå˜—è©¦é™ç´šåˆ°æœ¬æ©Ÿæ¨¡å¼
        useLocalStorage = true;
        saveLocalScore(score);
      }
    }

    function listenToLeaderboard() {
      if (useLocalStorage) {
          loadLocalLeaderboard();
          return;
      }

      if (!db) return;
      const scoresCollection = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
      
      onSnapshot(scoresCollection, (snapshot) => {
        const scores = [];
        snapshot.forEach((doc) => {
          scores.push(doc.data());
        });

        scores.sort((a, b) => b.score - a.score);
        updateLeaderboardDisplay(scores);
      }, (error) => {
        console.error("Leaderboard error:", error);
        // å‡ºéŒ¯æ™‚åˆ‡æ›åˆ°æœ¬æ©Ÿ
        useLocalStorage = true;
        loadLocalLeaderboard();
      });
    }

    // --- æœ¬æ©Ÿå„²å­˜ (Local Storage) ç›¸é—œå‡½å¼ ---
    function saveLocalScore(score) {
        try {
            const lsKey = 'music_quiz_scores';
            let scores = JSON.parse(localStorage.getItem(lsKey) || '[]');
            
            // æª¢æŸ¥è©²ä½¿ç”¨è€…æ˜¯å¦å·²æœ‰ç´€éŒ„ (ä½¿ç”¨ sessionUid)
            const existingIndex = scores.findIndex(s => s.uid === sessionUid);
            
            if (existingIndex >= 0) {
                scores[existingIndex].score = score;
                scores[existingIndex].name = userName; // æ›´æ–°åç¨±
                scores[existingIndex].timestamp = Date.now();
            } else {
                scores.push({
                    uid: sessionUid,
                    name: userName,
                    score: score,
                    timestamp: Date.now()
                });
            }
            
            localStorage.setItem(lsKey, JSON.stringify(scores));
            loadLocalLeaderboard(); // åˆ·æ–°é¡¯ç¤º
        } catch (e) {
            console.error("Local storage error:", e);
        }
    }

    function loadLocalLeaderboard() {
        try {
            const lsKey = 'music_quiz_scores';
            let scores = JSON.parse(localStorage.getItem(lsKey) || '[]');
            
            // æ’åº
            scores.sort((a, b) => b.score - a.score);
            
            // é¡¯ç¤º
            updateLeaderboardDisplay(scores, "ç›®å‰é‚„æ²’æœ‰äººä¸Šæ¦œ (æœ¬æ©Ÿæ¨¡å¼)ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€åï¼");
        } catch (e) {
            console.error("Local storage load error:", e);
        }
    }

    // çµ±ä¸€æ›´æ–°æ‰€æœ‰æ’è¡Œæ¦œåˆ—è¡¨ (ç™»å…¥é  & çµç®—é )
    function updateLeaderboardDisplay(scores, emptyMessage = "ç›®å‰é‚„æ²’æœ‰äººä¸Šæ¦œï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€åï¼") {
      const lists = document.querySelectorAll(".leaderboard-list");
      
      lists.forEach(list => {
        list.innerHTML = "";
        
        if (scores.length === 0) {
          list.innerHTML = `<li class='leaderboard-item'>${emptyMessage}</li>`;
          return;
        }

        scores.forEach((item, index) => {
          const li = document.createElement("li");
          li.className = "leaderboard-item";
          
          let rankClass = "";
          if (index === 0) rankClass = "rank-1";
          else if (index === 1) rankClass = "rank-2";
          else if (index === 2) rankClass = "rank-3";

          li.innerHTML = `
            <span>
              <span class="rank-badge ${rankClass}">#${index + 1}</span>
              ${escapeHtml(item.name)}
            </span>
            <span class="score-badge">${item.score} é¡Œ</span>
          `;
          list.appendChild(li);
        });
      });
    }

    function escapeHtml(text) {
      if (!text) return text;
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

  </script>

</body>
</html>